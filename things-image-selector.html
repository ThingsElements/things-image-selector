<link ref="import" href="../polymer/polymer.html">
<link ref="import" href="../iron-input/iron-input.html">
<link ref="import" href="../iron-icon/iron-icon.html">
<link ref="import" href="../paper-icon-button/paper-icon-button.html">
<link ref="import" href="../paper-dialog/paper-dialog.html">
<link ref="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link ref="import" href="../paper-toolbar/paper-toobar.html">
<link ref="import" href="../things-ajax/things-ajax.html">
<link ref="import" href="../things-card-image/things-card-image-list.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../things-global-behavior/things-global-behavior.html">
<link rel="import" href="../things-view-open-behavior/things-view-open-behavior.html">
<link rel="import" href="../things-upload/things-file-upload.html">

<!--
`<things-image-selector>` Things Image Selector

  Example
    
    <things-image-selector
      resource-url="attachments">
    </things-image-selector>

@demo demo/index.html
-->
<dom-module id="things-image-selector">
  <style>
    label{
      @apply(--things-label);
    }
    input{
      @apply(--things-input);
      width:calc(65% - 37px);
    }
    paper-icon-button{
      @apply(--things-small-icon);
      margin-right:7px;margin-left:-27px;
      opacity:.4;
      position:relative;
      top:-2px;
    }
    iron-icon{
      @apply(--things-picker-button);
      background:url(/images/icon-resource-select.png) 50% -147px no-repeat var(--paper-blue-grey-300);
    }
    paper-dialog {
    position: fixed;
    top: 10%;
    bottom:10%;
    left: 15%;
    right: 15%;
    margin: 0px;
    @apply(--layout-flex);
    @apply(--layout-vertical);
    }
    paper-toolbar{
      background-color:var(--things-primary-background-color);
      height:45px;
      margin-top:0px !important;
      @apply(--things-padding-clear)
    }
    paper-toolbar::shadow #topBar{
      height:45px;
    } 
    paper-toolbar .title{
      margin-left:32px !important;
      line-height:initial !important;
    }
    fixedorm{
      @apply(--things-default-padding);
      padding-bottom:5px;
      border-bottom:1px solid rgba(0,0,0,.1);
    }
    paper-fab{
      @apply(--things-search-fab);
    }
    .close-btn{
      @apply(--things-header-button);
      background:url(/images/icon-close.png) 100% 50% no-repeat;
      margin-right:10px;
    }
    .container {
      overflow-y: auto;
    }    
  </style>
  <template>    
    <label>[[label]]</label>
    <input is="iron-input" bind-value="[[value]]" readonly>
    <paper-icon-button suffix on-tap="clearValue" icon="clear" alt="clear" title="clear">
    </paper-icon-button>
    <iron-icon prefix on-tap="toggleImageSelector"></iron-icon>

    <things-ajax
      id="attachment-search"
      method="GET"
      resource-url="[[resourceUrl]]"
      resource-action="index" 
      page="[[page]]" 
      limit="[[limit]]"
      sort-fields="[[sortFields]]"
      loading="{{loading}}"
      last-response="{{lastResponse}}">
    </things-ajax>

    <paper-dialog
      id="dialog"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation"
      modal>
      <paper-toolbar>
        <span class="title">[[title]]</span>
        <div class="buttonsGroup">
          <button dialog-dismiss class="close-btn"></button>
        </div>
      </paper-toolbar>

      <things-card-image-list
        id="card-list"
        class="container"
        items="[[newItems]]"
        image-field="id"
        detail-fields="[[detailFields]]"
        is-selector
        display-full-url>
      </things-card-image-list>

      <iron-scroll-threshold
        id="scroller"
        scroll-target="card-list"
        on-lower-threshold="goNextPage">
      </iron-scroll-threshold>

      <things-button on-tap="refreshImages" hidden="[[!useUpload]]">Refresh</things-button>
      <things-button on-tap="toggleFileUpload" hidden="[[!useRefresh]]">Upload</things-button>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'things-image-selector',

      behaviors: [
        Things.GlobalBehavior,
        Things.ViewOpenBehavior
      ],      

      properties: {
        
        /**
         * selector field 앞에 붙는 label property
         */
        label: {
          type: String
        },

        /**
         * image 선택시 field에 mapping 되는 value property
         */
        value: {
          type: String,
          observer: '_valueChanged'
        },

        /**
         * selector dialog 상단에 표기 되는 title
         */
        title: {
          type: String,
          value: 'Image Selector'
        },

        /**
         * image objects를 호출할 resource url
         */
        resourceUrl: {
          type: String,
          value: 'attachments/list/image'
        },

        /**
         * 총 페이지 수
         */
        totalCount: {
          type: Number,
          value: 0
        },

        /**
         * 현재 페이지
         */
        page: {
          type: Number,
          value: 1
        },

        /**
         * 한 페이지 당 보여질 레코드 수 
         */
        limit: {
          type: Number,
          value: 50
        },

        /**
         * ajax 호출을 통해 받는 response
         */
        lastResponse: {
          type: Object,
          observer: '_responseChanged'
        },

        /**
         * image가 아닌 파일들을 필터링한 후 초기화 하는 items object
         */
        newItems: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * detail form field에 mapping 시킬 data 목록들로 빈간이 없이 ','로 구분하여 입력합니다.
         * ex) name,description,file_size
         */
        detailFields: {
          type: String,
          value: 'file_size'
        },

        /**
         * 선택한 이미지의 metaData가 담겨 있는 Object
         */
        metaData: {
          type: Object
        },

        /**
         * input field에 표시할 field 값을 선택 합니다.
         * 기본값은 name 필드
         */
        displayField: {
          type: String,
          value: 'name'
        },

        /**
         * input field에 full url을 표시할지 여부를 결정 합니다.
         */
        displayFullUrl: {
          type: Boolean,
          value: false
        },

        /**
         * baseUrl을 변수화 하기 위해 사용하는 property
         */
        baseUrlAlias: {
          type: String
        },

        /**
         * storage를 초기에 설정하기 위한 property
         */
        defaultUploadStorage: {
          type: String
        },

        /**
         * ajax sorting field
         */
        sortFields: {
          type: Array,
          value: function() {
            return [ { field: 'created_at', ascending: false } ];
          }
        },

        /**
         * upload 버튼 활성화 여부
         */
        useUpload: {
          type: Boolean,
          value: false
        },

        /**
         * refresh 버튼 활성화 여부
         */
        useRefresh: {
          type: Boolean,
          value: false
        }
      },

      listeners: {
        'things-card-image-selected' : '_onImageSelected',
        'scroller.lower-threshold':'goNextPage'
      },

      /**
       * dialog에서 image를 클릭하면 value와 metaData에 Obj형태의 detail 정보를 담는다.
       * 만약 displayField가 정의 되었다면 detail에서 해당 필드 값을 value에 초기화 함 (기본값은 name)
       */
      _onImageSelected: function(e) {
        var baseUrl = this.baseUrlAlias ? this.baseUrlAlias : this.get('globals.baseUrl');
        var tempValue = e.detail[this.displayField];

        this.value = (this.displayFullUrl) ? (baseUrl + '/download/' + tempValue) : tempValue;
        
        e.detail.value = this.value;
        this.metaData = e.detail;
        
        this.$['dialog'].close();
      },

      /**
       * ajax 호출을 통해 받은 lastResponse에서 image 파일이 아닌 것들을 filltering
       */
      _responseChanged: function(lastResponse) {
        var newItems = lastResponse && lastResponse.items ? lastResponse.items : [];
        this.totalCount = lastResponse && lastResponse.total ? lastResponse.total : this.newItems.length;
        newItems.forEach(function(item) { item.attachment_id = item.id; });
        
        this.newItems = (this.page == 1) ? newItems : this.newItems.concat(newItems);
      },

      /**
       * value 값이 변경 되었을때 발생하는 이벤트
       */
      _valueChanged: function(value) {
        this.fire('things-value-changed', value);
      },      

      /**
       * 버튼 클릭시 image selector dialog toggle
       */
      toggleImageSelector: function() {
        if(this.newItems && this.newItems.length > 0) {
          this.newItems = [];
        }

        this.$['attachment-search'].generateRequest();
        this.$['dialog'].open();
      },

      /**
       * 셀렉터에 출력된 이미지를 refresh하는 버튼
       */
      refreshImages: function() {
        this.page = 1;
        this.$['attachment-search'].generateRequest();
      },

      /**
       * 버튼 클릭시 upload dialog toggle
       */
      toggleFileUpload: function() {
        var upload = document.createElement('things-file-upload');
        upload.id = 'file-upload';
        upload.target = 'upload';
        upload.method = 'POST';
        upload.timeout = 300000;
        upload.hidden = false;
        upload.defaultStorage = this.defaultUploadStorage;
        this.openPopupView(upload, true);
      },

      /**
       * 다음 페이지 이동
       */
      goNextPage: function() {
        if(this.totalCount == 0){
          this.$.scroller.clearTriggers();
          return;
        }

        if((this.page * this.limit) < this.totalCount) {
          this.page = this.page + 1;
          this.$['attachment-search'].generateRequest();
        }
        this.$.scroller.clearTriggers();
      },

      /**
       * 선택한 이미지의 정보들을 삭제 합니다.
       */
      clearValue: function() {
        this.value = '';
        this.metaData = '';
      }

    });
  </script>
</dom-module>