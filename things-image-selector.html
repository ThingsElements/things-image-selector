<link ref="import" href="../polymer/polymer.html">
<link ref="import" href="../iron-input/iron-input.html">
<link rel="import" href="things-image-selector-dialog.html">

<!--
`<things-image-selector>` Things Image Selector

  Example

    <things-image-selector
      resource-url="attachments">
    </things-image-selector>

@demo demo/index.html
-->
<dom-module id="things-image-selector">
    <style>
        :host {
            display: block;
            background-color: var(--things-whitegrey-background-color);
        }
        label {
            @apply(--things-label);
        }
        input {
            @apply(--things-input);
            width: calc(65% - 37px);
        }
        paper-icon-button {
            @apply(--things-small-icon);
            margin-right: 7px;
            margin-left: -27px;
            opacity: .4;
            position: relative;
            top: -2px;
        }
        iron-icon {
            @apply(--things-picker-button);
            background: url(/images/icon-resource-select.png) 50% -147px no-repeat var(--paper-blue-grey-300);
        }        
    </style>
    <template>
        <label>[[label]]</label>
        <input is="iron-input" bind-value="{{value}}">
        <paper-icon-button suffix on-tap="clearValue" icon="clear" alt="clear" title="clear">
        </paper-icon-button>
        <iron-icon prefix on-tap="toggleBtnTap"></iron-icon>
        <things-image-selector-dialog id="image-selector-dialog"></things-image-selector-dialog>
    </template>
    <script>
        Polymer({
            is: 'things-image-selector',

            behaviors: [
                Things.GlobalBehavior,
                Things.ViewOpenBehavior
            ],

            properties: {
                /**
                 * selector field 앞에 붙는 label property
                 */
                label: {
                    type: String
                },

                /**
                 * image 선택시 field에 mapping 되는 value property
                 */
                value: {
                    type: String,
                    observer: '_valueChanged'
                },

                /**
                 * 선택한 이미지의 metaData가 담겨 있는 Object
                 */
                metaData: {
                    type: Object
                },

                /**
                 * image objects를 호출할 resource url
                 */
                resourceUrl: {
                    type: String,
                    value: 'attachments/list/image'
                },

                /**
                 * detail form field에 mapping 시킬 data 목록들로 빈간이 없이 ','로 구분하여 입력합니다.
                 * ex) name,description,file_size
                 */
                detailFields: {
                    type: String,
                    value: 'file_size'
                },

                /**
                 * input field에 표시할 field 값을 선택 합니다.
                 * 기본값은 name 필드
                 */
                displayField: {
                    type: String,
                    value: 'name'
                },

                /**
                 * input field에 full url을 표시할지 여부를 결정 합니다.
                 */
                displayFullUrl: {
                    type: Boolean,
                    value: false
                },

                /**
                 * baseUrl을 변수화 하기 위해 사용하는 property
                 */
                baseUrlAlias: {
                    type: String
                },

                /**
                 * storage를 초기에 설정하기 위한 property
                 */
                defaultStorage: {
                    type: String,
                  observer: '_defaultStorageChanged'
                },

                /**
                 * 이름으로 검색 할 때 추가되는 검색 조건
                 */
                queryFields: {
                    type: Array,
                  value: []
                },

                /**
                 * storage combo를 통해 검색 조건을 설정하기 위한 property
                 */
                storageFilters: {
                    type: Array
                },

                /**
                 * upload 버튼 활성화 여부
                 */
                useUpload: {
                    type: Boolean,
                  value: false
                },

                /**
                 * 검색 조건에 쓰일 name
                 */
                searchName: {
                    type: String
                },

                /**
                 * 검색 조건에 쓰일 storage
                 */
                searchStorage: {
                    type: String
                },
            },

            /**
             * value 값이 변경 되었을때 발생하는 이벤트
             */
            _valueChanged: function(value) {
                this.fire('things-image-changed', value);
            },

            toggleBtnTap: function() {
                var dataObj = {
                    owner: this,
                    resourceUrl: this.resourceUrl,
                    detailFields: this.detailFields,
                    displayField: this.displayField,
                    displayFullUrl: this.displayFullUrl,
                    baseUrlAlias: this.baseUrlAlias,
                    defaultStorage: this.defaultStorage,
                    sortFields: this.sortFields,
                    queryFields: this.queryFields,
                    storageFilters: this.storageFilters,
                    useUpload: this.useUpload,
                    searchName: this.searchName,
                    searchStorage: this.searchStorage
                };

                this.$['image-selector-dialog'].dialogToggle(dataObj, this._applySelectedImage);
            },

            _applySelectedImage: function(dataObj) {
                this.value = dataObj.value;
            },       

            /**
             * 선택한 이미지의 정보들을 삭제 합니다.
             */
            clearValue: function() {
                this.value = '';
                this.metaData = '';
            }
        });

    </script>
</dom-module>
